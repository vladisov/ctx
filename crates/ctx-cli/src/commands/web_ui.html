<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ctx - Terminal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            overflow: hidden;
        }
        #terminal-container {
            width: 100%;
            height: 100%;
            padding: 8px;
        }
        .xterm {
            height: 100%;
        }
        #status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            border-radius: 4px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 12px;
            z-index: 1000;
            transition: opacity 0.3s;
        }
        #status.connected { background: #4caf50; color: white; }
        #status.disconnected { background: #f44336; color: white; }
        #status.connecting { background: #ff9800; color: white; }
        #reconnect-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        #reconnect-overlay.active { display: flex; }
        #reconnect-box {
            background: #16213e;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            color: #eee;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        #reconnect-box h3 { color: #4fc3f7; margin-bottom: 15px; }
        #reconnect-box button {
            background: #4fc3f7;
            color: #1a1a2e;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
        }
        #reconnect-box button:hover { background: #81d4fa; }
    </style>
</head>
<body>
    <div id="status" class="connecting">Connecting...</div>
    <div id="terminal-container"></div>
    <div id="reconnect-overlay">
        <div id="reconnect-box">
            <h3>Connection Lost</h3>
            <p>The terminal session has ended.</p>
            <button onclick="location.reload()">Reconnect</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.min.js"></script>
    <script>
        const term = new Terminal({
            cursorBlink: true,
            cursorStyle: 'block',
            fontSize: 14,
            fontFamily: 'Menlo, Monaco, "Courier New", monospace',
            theme: {
                background: '#1a1a2e',
                foreground: '#eee',
                cursor: '#4fc3f7',
                cursorAccent: '#1a1a2e',
                selectionBackground: 'rgba(79, 195, 247, 0.3)',
                black: '#1a1a2e',
                red: '#ef5350',
                green: '#4caf50',
                yellow: '#ffca28',
                blue: '#4fc3f7',
                magenta: '#ce93d8',
                cyan: '#4dd0e1',
                white: '#eee',
                brightBlack: '#555',
                brightRed: '#f44336',
                brightGreen: '#81c784',
                brightYellow: '#ffd54f',
                brightBlue: '#81d4fa',
                brightMagenta: '#e1bee7',
                brightCyan: '#80deea',
                brightWhite: '#fff'
            },
            allowProposedApi: true
        });

        const fitAddon = new FitAddon.FitAddon();
        const webLinksAddon = new WebLinksAddon.WebLinksAddon();

        term.loadAddon(fitAddon);
        term.loadAddon(webLinksAddon);

        const container = document.getElementById('terminal-container');
        term.open(container);
        fitAddon.fit();

        const status = document.getElementById('status');
        const overlay = document.getElementById('reconnect-overlay');

        function updateStatus(state, text) {
            status.className = state;
            status.textContent = text;
        }

        // WebSocket connection
        const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${wsProtocol}//${location.host}/ws`);
        ws.binaryType = 'arraybuffer';

        ws.onopen = () => {
            updateStatus('connected', 'Connected');
            setTimeout(() => { status.style.opacity = '0'; }, 2000);

            // Send initial size
            const dims = { cols: term.cols, rows: term.rows };
            ws.send(JSON.stringify({ type: 'resize', ...dims }));
        };

        ws.onmessage = (event) => {
            if (event.data instanceof ArrayBuffer) {
                const text = new TextDecoder().decode(event.data);
                term.write(text);
            } else {
                term.write(event.data);
            }
        };

        ws.onerror = (err) => {
            console.error('WebSocket error:', err);
            updateStatus('disconnected', 'Error');
        };

        ws.onclose = () => {
            updateStatus('disconnected', 'Disconnected');
            status.style.opacity = '1';
            overlay.classList.add('active');
        };

        // Terminal input -> WebSocket
        term.onData((data) => {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(data);
            }
        });

        // Handle resize
        window.addEventListener('resize', () => {
            fitAddon.fit();
            if (ws.readyState === WebSocket.OPEN) {
                const dims = { cols: term.cols, rows: term.rows };
                ws.send(JSON.stringify({ type: 'resize', ...dims }));
            }
        });

        // Focus terminal
        term.focus();
    </script>
</body>
</html>
